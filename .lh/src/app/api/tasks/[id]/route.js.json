{
    "sourceFile": "src/app/api/tasks/[id]/route.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1762628395227,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1762633852661,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,9 +10,9 @@\n     if (!rl.ok) return new Response(JSON.stringify({ message: 'Too many requests' }), { status: 429 });\r\n \r\n   const { user } = await getUserFromRequest(req);\r\n   const { id } = await params;\r\n-    const task = await Task.findOne({ _id: id, user: user._id });\r\n+    const task = await Task.findOne({ _id: id, userId: user._id.toString() });\r\n     if (!task) return new Response(JSON.stringify({ message: 'Not found' }), { status: 404 });\r\n     return new Response(JSON.stringify({ task }), { status: 200 });\r\n   } catch (err) {\r\n     if (err.message === 'NO_TOKEN' || err.message === 'INVALID_TOKEN') return new Response(JSON.stringify({ message: 'Unauthorized' }), { status: 401 });\r\n"
                },
                {
                    "date": 1762634581606,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -37,9 +37,13 @@\n     const v = parsed.data;\r\n     const update = {};\r\n     if (v.title !== undefined) update.title = v.title;\r\n     if (v.description !== undefined) update.description = v.description;\r\n-    if (v.completed !== undefined) update.completed = v.completed;\r\n+    if (v.completed !== undefined) {\r\n+      update.completed = v.completed;\r\n+      // Sync status field with completed field\r\n+      update.status = v.completed ? 'completed' : 'pending';\r\n+    }\r\n     if (v.dueAt !== undefined) update.dueAt = v.dueAt ? new Date(v.dueAt) : null;\r\n \r\n     const task = await Task.findOneAndUpdate({ _id: id, userId: user._id.toString() }, update, { new: true });\r\n     if (!task) return new Response(JSON.stringify({ message: 'Not found' }), { status: 404 });\r\n"
                }
            ],
            "date": 1762628395227,
            "name": "Commit-0",
            "content": "import Task from '@/models/Task';\r\nimport { getUserFromRequest } from '@/lib/auth';\r\nimport { rateLimit } from '@/lib/rateLimiter';\r\nimport { TaskUpdateSchema, TaskIdParamSchema } from '@/features/tasks/schemas';\r\nimport { connectToDatabase } from '@/lib/mongodb';\r\n\r\nexport async function GET(req, { params }) {\r\n  try {\r\n    const ip = req.headers.get('x-forwarded-for') || req.headers.get('x-real-ip') || 'unknown';\r\n    const rl = rateLimit(`tasks:get:${ip}`, 60, 60 * 1000);\r\n    if (!rl.ok) return new Response(JSON.stringify({ message: 'Too many requests' }), { status: 429 });\r\n\r\n  await connectToDatabase();\r\n  const { user } = await getUserFromRequest(req);\r\n  const { id } = await params;\r\n    const task = await Task.findOne({ _id: id, userId: user._id });\r\n    if (!task) return new Response(JSON.stringify({ message: 'Not found' }), { status: 404 });\r\n    return new Response(JSON.stringify({ task }), { status: 200 });\r\n  } catch (err) {\r\n    if (err.message === 'NO_TOKEN' || err.message === 'INVALID_TOKEN') return new Response(JSON.stringify({ message: 'Unauthorized' }), { status: 401 });\r\n    console.error(err);\r\n    return new Response(JSON.stringify({ message: 'Server error' }), { status: 500 });\r\n  }\r\n}\r\n\r\nexport async function PATCH(req, { params }) {\r\n  try {\r\n    const ip = req.headers.get('x-forwarded-for') || req.headers.get('x-real-ip') || 'unknown';\r\n    const rl = rateLimit(`tasks:update:${ip}`, 60, 60 * 1000);\r\n    if (!rl.ok) return new Response(JSON.stringify({ message: 'Too many requests' }), { status: 429 });\r\n\r\n  await connectToDatabase();\r\n  const { user } = await getUserFromRequest(req);\r\n  const { id } = TaskIdParamSchema.parse(await params);\r\n    const json = await req.json();\r\n    const parsed = TaskUpdateSchema.safeParse(json);\r\n    if (!parsed.success) {\r\n      return new Response(JSON.stringify({ message: 'Validation error', errors: parsed.error.flatten() }), { status: 400 });\r\n    }\r\n    const v = parsed.data;\r\n    const update = {};\r\n    if (v.title !== undefined) update.title = v.title;\r\n    if (v.description !== undefined) update.description = v.description;\r\n    if (v.completed !== undefined) {\r\n      update.completed = v.completed;\r\n      update.status = v.completed ? 'completed' : 'pending';\r\n      if (v.completed) update.completedAt = new Date();\r\n    }\r\n    if (v.dueAt !== undefined) update.dueAt = v.dueAt ? new Date(v.dueAt) : null;\r\n\r\n    const task = await Task.findOneAndUpdate({ _id: id, user: user._id }, update, { new: true });\r\n    if (!task) return new Response(JSON.stringify({ message: 'Not found' }), { status: 404 });\r\n    return new Response(JSON.stringify({ task }), { status: 200 });\r\n  } catch (err) {\r\n    if (err.message === 'NO_TOKEN' || err.message === 'INVALID_TOKEN') return new Response(JSON.stringify({ message: 'Unauthorized' }), { status: 401 });\r\n    console.error(err);\r\n    return new Response(JSON.stringify({ message: 'Server error' }), { status: 500 });\r\n  }\r\n}\r\n\r\nexport async function DELETE(req, { params }) {\r\n  try {\r\n    const ip = req.headers.get('x-forwarded-for') || req.headers.get('x-real-ip') || 'unknown';\r\n    const rl = rateLimit(`tasks:delete:${ip}`, 60, 60 * 1000);\r\n    if (!rl.ok) return new Response(JSON.stringify({ message: 'Too many requests' }), { status: 429 });\r\n\r\n  await connectToDatabase();\r\n  const { user } = await getUserFromRequest(req);\r\n  const { id } = await params;\r\n    const task = await Task.findOneAndDelete({ _id: id, userId: user._id });\r\n    if (!task) return new Response(JSON.stringify({ message: 'Not found' }), { status: 404 });\r\n    return new Response(null, { status: 204 });\r\n  } catch (err) {\r\n    if (err.message === 'NO_TOKEN' || err.message === 'INVALID_TOKEN') return new Response(JSON.stringify({ message: 'Unauthorized' }), { status: 401 });\r\n    console.error(err);\r\n    return new Response(JSON.stringify({ message: 'Server error' }), { status: 500 });\r\n  }\r\n}\r\n"
        }
    ]
}