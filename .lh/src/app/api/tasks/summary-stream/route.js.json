{
    "sourceFile": "src/app/api/tasks/summary-stream/route.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1762634898355,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1762635725703,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,9 +8,9 @@\n   try {\n     const ip = req.headers.get('x-forwarded-for') || req.headers.get('x-real-ip') || 'unknown';\n     const rl = rateLimit(`tasks:summary:${ip}`, 10, 60 * 1000); // 10 requests per minute\n     if (!rl.ok) {\n-      return new Response(JSON.stringify({ error: 'Too many requests' }), { \n+      return new Response(JSON.stringify({ error: 'Too many requests' }), {\n         status: 429,\n         headers: { 'Content-Type': 'application/json' }\n       });\n     }\n@@ -18,17 +18,17 @@\n     const { user } = await getUserFromRequest(req);\n     const { taskId, title, description } = await req.json();\n \n     if (!taskId || !title) {\n-      return new Response(JSON.stringify({ error: 'Task ID and title are required' }), { \n+      return new Response(JSON.stringify({ error: 'Task ID and title are required' }), {\n         status: 400,\n         headers: { 'Content-Type': 'application/json' }\n       });\n     }\n \n     const groqKey = process.env.GROQ_API_KEY;\n     if (!groqKey) {\n-      return new Response(JSON.stringify({ error: 'AI service not configured' }), { \n+      return new Response(JSON.stringify({ error: 'AI service not configured' }), {\n         status: 503,\n         headers: { 'Content-Type': 'application/json' }\n       });\n     }\n@@ -92,24 +92,24 @@\n     } catch (groqError) {\n       console.error('Groq API failed:', groqError);\n       // Fallback to simple summary\n       const fallbackSummary = `Task \"${title}\" has been completed successfully. ${description ? `The task involved: ${description}` : 'All objectives were met and the work is now finished.'}`;\n-      \n-      return new Response(JSON.stringify({ summary: fallbackSummary }), { \n+\n+      return new Response(JSON.stringify({ summary: fallbackSummary }), {\n         status: 200,\n         headers: { 'Content-Type': 'application/json' }\n       });\n     }\n \n   } catch (err) {\n     if (err.message === 'NO_TOKEN' || err.message === 'INVALID_TOKEN') {\n-      return new Response(JSON.stringify({ error: 'Unauthorized' }), { \n+      return new Response(JSON.stringify({ error: 'Unauthorized' }), {\n         status: 401,\n         headers: { 'Content-Type': 'application/json' }\n       });\n     }\n     console.error('Task summary generation failed:', err);\n-    return new Response(JSON.stringify({ error: 'Failed to generate summary' }), { \n+    return new Response(JSON.stringify({ error: 'Failed to generate summary' }), {\n       status: 500,\n       headers: { 'Content-Type': 'application/json' }\n     });\n   }\n"
                }
            ],
            "date": 1762634898355,
            "name": "Commit-0",
            "content": "import { rateLimit } from '@/lib/rateLimiter';\nimport { getUserFromRequest } from '@/lib/auth';\nimport Groq from 'groq-sdk';\n\nexport const runtime = 'nodejs';\n\nexport async function POST(req) {\n  try {\n    const ip = req.headers.get('x-forwarded-for') || req.headers.get('x-real-ip') || 'unknown';\n    const rl = rateLimit(`tasks:summary:${ip}`, 10, 60 * 1000); // 10 requests per minute\n    if (!rl.ok) {\n      return new Response(JSON.stringify({ error: 'Too many requests' }), { \n        status: 429,\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n\n    const { user } = await getUserFromRequest(req);\n    const { taskId, title, description } = await req.json();\n\n    if (!taskId || !title) {\n      return new Response(JSON.stringify({ error: 'Task ID and title are required' }), { \n        status: 400,\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n\n    const groqKey = process.env.GROQ_API_KEY;\n    if (!groqKey) {\n      return new Response(JSON.stringify({ error: 'AI service not configured' }), { \n        status: 503,\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n\n    const groq = new Groq({ apiKey: groqKey });\n\n    console.log('Starting Groq API streaming for task summary...');\n\n    // Generate a summary with streaming\n    const prompt = `Based on this completed task, generate a brief summary (2-3 sentences) of what was likely accomplished:\n\nTask Title: \"${title}\"\n${description ? `Description: \"${description}\"` : ''}\n\nFocus on the outcome and value delivered. Keep it professional and concise.`;\n\n    try {\n      const stream = await groq.chat.completions.create({\n        model: 'llama-3.1-8b-instant', // Updated to current Groq model\n        messages: [\n          { role: 'system', content: 'You are a helpful assistant that summarizes completed tasks professionally.' },\n          { role: 'user', content: prompt }\n        ],\n        max_tokens: 150,\n        temperature: 0.3,\n        stream: true, // Enable streaming\n      });\n\n      // Create a ReadableStream for SSE\n      const encoder = new TextEncoder();\n      const readableStream = new ReadableStream({\n        async start(controller) {\n          try {\n            for await (const chunk of stream) {\n              const content = chunk.choices[0]?.delta?.content || '';\n              if (content) {\n                // Send SSE formatted data\n                const data = `data: ${JSON.stringify({ content })}\\n\\n`;\n                controller.enqueue(encoder.encode(data));\n              }\n            }\n            // Send done signal\n            controller.enqueue(encoder.encode('data: [DONE]\\n\\n'));\n            controller.close();\n            console.log('Groq API streaming completed successfully');\n          } catch (error) {\n            console.error('Streaming error:', error);\n            controller.error(error);\n          }\n        },\n      });\n\n      return new Response(readableStream, {\n        headers: {\n          'Content-Type': 'text/event-stream',\n          'Cache-Control': 'no-cache',\n          'Connection': 'keep-alive',\n        },\n      });\n\n    } catch (groqError) {\n      console.error('Groq API failed:', groqError);\n      // Fallback to simple summary\n      const fallbackSummary = `Task \"${title}\" has been completed successfully. ${description ? `The task involved: ${description}` : 'All objectives were met and the work is now finished.'}`;\n      \n      return new Response(JSON.stringify({ summary: fallbackSummary }), { \n        status: 200,\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n\n  } catch (err) {\n    if (err.message === 'NO_TOKEN' || err.message === 'INVALID_TOKEN') {\n      return new Response(JSON.stringify({ error: 'Unauthorized' }), { \n        status: 401,\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n    console.error('Task summary generation failed:', err);\n    return new Response(JSON.stringify({ error: 'Failed to generate summary' }), { \n      status: 500,\n      headers: { 'Content-Type': 'application/json' }\n    });\n  }\n}\n"
        }
    ]
}